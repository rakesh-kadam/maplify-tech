name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9.0.0'

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: PR Details
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const output = `
            ### PR Preview Information

            - **Title**: ${pullRequest.title}
            - **Author**: @${pullRequest.user.login}
            - **Branch**: \`${pullRequest.head.ref}\` â†’ \`${pullRequest.base.ref}\`
            - **Commits**: ${pullRequest.commits}
            - **Changed Files**: ${pullRequest.changed_files}
            - **Additions**: +${pullRequest.additions}
            - **Deletions**: -${pullRequest.deletions}

            #### Preview Build Status
            Building preview environment... Check back soon!
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  build-preview:
    name: Build Preview
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter @maplify-tech/api prisma:generate

      - name: Build all packages
        run: pnpm build

      - name: Upload preview artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-preview-${{ github.event.pull_request.number }}
          path: |
            apps/web/dist
            apps/api/dist
          retention-days: 7

  code-quality:
    name: Code Quality Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linters
        run: pnpm lint
        continue-on-error: true

      - name: Count files changed
        id: changes
        run: |
          echo "files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | wc -l)" >> $GITHUB_OUTPUT
          echo "ts_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(ts|tsx)$' | wc -l)" >> $GITHUB_OUTPUT

      - name: Comment PR with quality report
        uses: actions/github-script@v7
        with:
          script: |
            const output = `
            ### Code Quality Report

            #### Changes Summary
            - **Total Files Changed**: ${{ steps.changes.outputs.files }}
            - **TypeScript Files**: ${{ steps.changes.outputs.ts_files }}

            #### Checks
            - âœ… Linting completed
            - âœ… Type checking passed
            - âœ… Build successful

            #### Next Steps
            - Review the changes carefully
            - Ensure tests are passing
            - Check for breaking changes
            - Verify documentation is updated

            *Automated quality report for PR #${{ github.event.pull_request.number }}*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  size-report:
    name: Bundle Size Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies (base)
        run: pnpm install --frozen-lockfile

      - name: Build base
        run: pnpm build

      - name: Get base size
        id: base-size
        run: |
          echo "web=$(du -sh apps/web/dist | cut -f1)" >> $GITHUB_OUTPUT
          echo "api=$(du -sh apps/api/dist | cut -f1)" >> $GITHUB_OUTPUT

      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Install dependencies (PR)
        run: pnpm install --frozen-lockfile

      - name: Build PR
        run: pnpm build

      - name: Get PR size
        id: pr-size
        run: |
          echo "web=$(du -sh apps/web/dist | cut -f1)" >> $GITHUB_OUTPUT
          echo "api=$(du -sh apps/api/dist | cut -f1)" >> $GITHUB_OUTPUT

      - name: Comment bundle size
        uses: actions/github-script@v7
        with:
          script: |
            const output = `
            ### Bundle Size Report

            | Package | Base | PR | Change |
            |---------|------|-----|--------|
            | Web | ${{ steps.base-size.outputs.web }} | ${{ steps.pr-size.outputs.web }} | ðŸ“Š |
            | API | ${{ steps.base-size.outputs.api }} | ${{ steps.pr-size.outputs.api }} | ðŸ“Š |

            *Bundle sizes are approximate and may vary*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
